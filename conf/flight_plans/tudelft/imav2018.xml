<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan ground_alt="160" lat0="-37.623545" lon0="145.125950" max_dist_from_home="450" name="IMAV 2018" alt="165.0" security_height="0.3">
  <header>
#include "autopilot.h"
#include "subsystems/datalink/datalink.h"
#include "subsystems/electrical.h"
#include "modules/percevite/percevite.h"

// Note: use 'git submodule update --init -- sw/ext/tudelft_gazebo_models/'
// to download the required models.
#define NPS_GAZEBO_WORLD "imav2018.world"
  </header>
  <waypoints>
    <waypoint name="HOME" x="0.0" y="0.0" height="2.0"/>
    <waypoint name="GOAL" x="2.0" y="2.0" height="2.0"/>
    <waypoint name="STDBY" x="-0.7" y="-0.8" height="2.0"/>
    <waypoint name="TD" x="0.8" y="-1.7"/>
    <waypoint name="_PERCEVITE" x="0.0" y="0.0"/>
    <waypoint name="_RED1" lat="-37.622878" lon="145.126976"/>
    <waypoint name="_RED2" lat="-37.624535" lon="145.126501"/>
    <waypoint name="_RED3" lat="-37.624522" lon="145.122122"/>
    <waypoint name="_RED4" lat="-37.623597" lon="145.122882"/>
    <waypoint name="_RED5" lat="-37.623165" lon="145.122854"/>
    <waypoint name="_RED6" lat="-37.622681" lon="145.122519"/>
    <waypoint name="_RED7" lat="-37.622338" lon="145.122849"/>
  </waypoints>
  <sectors>
    <sector name="FlyZone" color="red" type="dynamic">
      <corner name="_RED1"/>
      <corner name="_RED2"/>
      <corner name="_RED3"/>
      <corner name="_RED4"/>
      <corner name="_RED5"/>
      <corner name="_RED6"/>
      <corner name="_RED7"/>
    </sector>
  </sectors>
  <exceptions>
    <!-- IMAV2018 REQUIRED EXCEPTIONS -->
    <!-- Control link lost -->
    <exception cond="((datalink_time > 5) &&
      (nav_block > IndexOfBlock('Holding point')) &&
      (IndexOfBlock('flare') > nav_block) &&
      (autopilot_in_flight() == true))" deroute="Land here and kill"/>
    <!--  Horizontal geofence -->
    <exception cond="((!InsideFlyZone(GetPosX(), GetPosY())) &&
      (nav_block > IndexOfBlock('Holding point')) &&
      (IndexOfBlock('flare') > nav_block) &&
      (autopilot_in_flight() == true))" deroute="HOME"/>
    <!-- Vertical geofence -->
    <!-- Note: triggers at 180m MSL, 20m above takeoff elevation -->
    <exception cond="((GetPosAlt() > 180.0) && 
      (nav_block > IndexOfBlock('Holding point')) &&
      (IndexOfBlock('flare') > nav_block) &&
      (autopilot_in_flight() == true))" deroute="Land here and kill"/>
    
    <!-- OTHER EXCEPTIONS -->
    <!-- Low battery -->
    <exception cond="(electrical.bat_low &&
      !(IndexOfBlock('Holding point') > nav_block) &&
      !(nav_block >= IndexOfBlock('Land here')) &&
      (autopilot_in_flight() == true) )" deroute="Land here"/>
    <exception cond="(electrical.bat_critical &&
      !(IndexOfBlock('Holding point') > nav_block) &&
      !(nav_block >= IndexOfBlock('Land here')) &&
      (autopilot_in_flight() == true) )" deroute="Land here"/>
    <!-- Percevite error -->
    <exception cond="(!PerceviteOk() &&
      (IndexOfBlock('Takeoff') > nav_block))" deroute="PercEvite init"/>
    <exception cond="(!PerceviteOk() &&
      !(IndexOfBlock('Holding point') > nav_block) &&
      !(nav_block >= IndexOfBlock('Land here')) &&
      (autopilot_in_flight() == true) )" deroute="Land here"/>
  </exceptions>
  <blocks>
    <block name="GPS init">
      <call_once fun="NavKillThrottle()"/>
      <while cond="!GpsFixValid()"/>
      <while cond="LessThan(NavBlockTime(), 20)"/>
      <call_once fun="NavSetGroundReferenceHere()"/>
      <!-- <call_once fun="NavSetAltitudeReferenceHere()"/> -->
      <call_once fun="geo_mag_periodic()"/>
      <call_once fun="geo_mag_event()"/>
    </block>
    <block name="PercEvite init">
      <!-- <call_once fun="FollowTerrainInit(WP_GOAL)"/> -->
      <call_once fun="PerceviteInit(WP__PERCEVITE)"/>
      <while cond="!PerceviteOk()"/>
    </block>
    <block name="Holding point">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="Start Engine">
      <call_once fun="NavResurrect()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
      <exception cond="stateGetPositionEnu_f()->z > 1.0" deroute="Standby"/>
      <call_once fun="NavSetWaypointHere(WP_STDBY)"/>
      <stay climb="nav_climb_vspeed" vmode="climb" wp="STDBY"/>
    </block>
    
    <block name="Standby" strip_button="Standby" strip_icon="home.png">
      <call_once fun="NavSetWaypointHere(WP_STDBY)"/>
      <stay wp="STDBY"/>
    </block>
    <block name="Go">
      <call fun="PerceviteStay(WP_GOAL)"/>
    </block>
    
    <block name="Land here" strip_button="Land Here" strip_icon="land-right.png">
      <call_once fun="NavSetWaypointHere(WP_TD)"/>
    </block>
    <block name="land">
      <go wp="TD"/>
    </block>
    <block name="flare">
      <!-- <exception cond="NavDetectGround()" deroute="Holding point"/> -->
      <!-- <exception cond="!nav_is_in_flight()" deroute="landed"/> -->
      <!-- <call_once fun="NavStartDetectGround()"/> -->
      <stay climb="nav_descend_vspeed" vmode="climb" wp="TD"/>
    </block>
    <!-- <block name="landed">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block> -->
    
    <block name="EXCEPTIONS"/>
    <block name="KILL">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block name="Land here and kill">
      <call_once fun="NavSetWaypointHere(WP_TD)"/>
      <go wp="TD"/>
      <exception cond="NavDetectGround()" deroute="KILL"/>
      <exception cond="!nav_is_in_flight()" deroute="KILL"/>
      <call_once fun="NavStartDetectGround()"/>
      <stay wp="TD" vmode="climb" climb="nav_descend_vspeed"/>
    </block>
  </blocks>
</flight_plan>
