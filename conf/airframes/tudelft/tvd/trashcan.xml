<!DOCTYPE airframe SYSTEM "../../airframe.dtd">

<airframe name="trashcan">
  <description>
    * Airframe for the regular "Trashcan" Quadrotor frame equipped with to validate all onboard
    functionally.
    + Autopilot: Default Crazybee F4 Pro STM32F4 and all that comes with it
    + Actuators: Default onboard Blheli S ESCs see
    http://wiki.paparazziuav.org/wiki/Subsystem/actuators#PWM
    + Telemetry: Default WiFi Via ESP8266 see
    + RC RX: OpenRX FrSky compatible over air 2.4Ghz CPPM out on LED pin

    NOTES:
    + All set to expect flying on 2s LiPo battery, 1s LiPo battery possible but no gains set (yet..)
    + Removed Camera and Video TX to be replaced by a JeVois (www.jevois.org) camera on Uart1
    + RC control also possible via wifi telemetry module
    + Vison: added a JeVois on UART1 TX/RX
    + RC RX: OpenRX FrSky compatible over air 2.4Ghz CPPM out,
    + Wifi telemetry module also allows RC

    WIP:
    + GPS: uBlox SAM M8Q with Magneto n Baro GNSS
  </description>

  <firmware name="rotorcraft">
    <target name="ap" board="crazybee_f4_1.0">
      <define name="USE_PERSISTENT_SETTINGS" value="TRUE" />
    </target>
    
    <!-- <configure name="PERIODIC_FREQUENCY" value="2048" /> --><!-- Why? -->

    <!-- Control loop -->
    <module name="imu" type="mpu6000">
      <configure name="IMU_MPU_SPI_DEV" value="spi1" />
      <configure name="IMU_MPU_SPI_SLAVE_IDX" value="SPI_SLAVE0" />
    </module>
    <module name="ahrs" type="float_cmpl_quat">
      <configure name="USE_MAGNETOMETER" value="FALSE" />
    </module>
    <module name="ins" type="extended" />
    <module name="motor_mixing" />
    <module name="stabilization" type="int_quat" />
    <module name="actuators" type="pwm">
      <define name="SERVO_HZ" value="480" /><!-- Why? -->
    </module>
    
    <!-- Radio control and telemetry -->
    <module name="radio_control" type="cc2500_frsky" />
    <module name="dfu_command" />
    <!-- <module name="telemetry" type="transparent_usb"/> -->
    <module name="telemetry" type="transparent_frsky_x" />
    <!-- <module name="pidtuner" /> -->
    
    <!-- Flowdeck -->
    <!-- <define name="USE_SOFTI2C0"/>
    <define name="SOFTI2C0_SCL_GPIO" value="LED_STRIP_GPIO_PORT"/>
    <define name="SOFTI2C0_SCL_PIN" value="LED_STRIP_GPIO_PIN"/>
    <define name="SOFTI2C0_SDA_GPIO" value="SPI_SELECT_SLAVE1_PORT"/>
    <define name="SOFTI2C0_SDA_PIN" value="SPI_SELECT_SLAVE1_PIN"/>
    <module name="gpio_ext" type="pca95xx"/>
    <module name="sonar" type="vl53l1x">
      <configure name="SONAR_VL53L1X_I2C_DEV" value="softi2c0"/>
    </module>
    <module name="opticflow" type="pmw3901">
      <configure name="OPTICFLOW_PMW3901_SPI_DEV" value="SPI2"/>
      <configure name="OPTICFLOW_PMW3901_SPI_SLAVE_IDX" value="3"/>
      <define name="SPI_SELECT_SLAVE3_PORT" value="GPIOEXT1"/>
      <define name="SPI_SELECT_SLAVE3_PIN" value="GPIOE2"/>
    </module> -->
    
    <!-- GPS -->
    <module name="gps" type="datalink" /> <!-- using optitrack and natnet2ivy -->
  </firmware>
  
  
  <servos driver="Pwm">
    <servo name="FL" no="3" min="1000" neutral="1150" max="2000" />
    <servo name="FR" no="1" min="1000" neutral="1150" max="2000" />
    <servo name="BR" no="0" min="1000" neutral="1150" max="2000" />
    <servo name="BL" no="2" min="1000" neutral="1150" max="2000" />
  </servos>
  
  <commands>
    <axis name="ROLL" failsafe_value="0" />
    <axis name="PITCH" failsafe_value="0" />
    <axis name="YAW" failsafe_value="0" />
    <axis name="THRUST" failsafe_value="0" />
  </commands>
  
  <section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="REVERSE" value="TRUE" />
    <define name="TYPE" value="QUAD_X" />
  </section>
  
  <command_laws>
    <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)" />
    <set servo="FL" value="motor_mixing.commands[MOTOR_FRONT_LEFT]" />
    <set servo="FR" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]" />
    <set servo="BR" value="motor_mixing.commands[MOTOR_BACK_RIGHT]" />
    <set servo="BL" value="motor_mixing.commands[MOTOR_BACK_LEFT]" />
  </command_laws>
  
  
  <section name="IMU" prefix="IMU_">
     <!-- To be able (for now) to set AP IMU orientaion --><!-- TODO check redundancy -->
    <define name="GYRO_P_SIGN" value="1" />
    <define name="GYRO_Q_SIGN" value="-1" />
    <define name="GYRO_R_SIGN" value="-1" />
    <define name="ACCEL_X_SIGN" value="1" />
    <define name="ACCEL_Y_SIGN" value="-1" />
    <define name="ACCEL_Z_SIGN" value="-1" />
    <define name="BODY_TO_IMU_PHI" value="0." unit="deg" />
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg" />
    <define name="BODY_TO_IMU_PSI" value="90." unit="deg" />
    <!-- Tere is no MAG per default, but in case one adds one , make it correct -->
    <define name="MAG_X_SIGN" value="1" />
    <define name="MAG_Y_SIGN" value="1" />
    <define name="MAG_Z_SIGN" value="1" />
    <!-- replace this with your own calibration -->
    <define name="ACCEL_X_NEUTRAL" value="0" />
    <define name="ACCEL_Y_NEUTRAL" value="0" />
    <define name="ACCEL_Z_NEUTRAL" value="0" />
    <!-- replace this with your own calibration -->
    <define name="MAG_X_NEUTRAL" value="0" />
    <define name="MAG_Y_NEUTRAL" value="0" />
    <define name="MAG_Z_NEUTRAL" value="0" />
    <define name="MAG_X_SENS" value="8.0" integer="16" />
    <define name="MAG_Y_SENS" value="8.0" integer="16" />
    <define name="MAG_Z_SENS" value="8.0" integer="16" />
  </section>

  <section name="FILTER_1EURO" prefix="FILTER_1EURO_"><!-- TODO test -->
    <define name="ENABLED" value="FALSE" /> <!-- activate or not the filter by default -->
    <define name="GYRO_MINCUTOFF" value="10." /> <!-- minimum cutoff freq for gyro signal -->
    <define name="GYRO_BETA" value="0.1" /> <!-- adaptation coefficient for gyro signal -->
    <define name="ACCEL_MINCUTOFF" value="0.1" /> <!-- minimum cutoff freq for accel signal -->
    <define name="ACCEL_BETA" value="0.01" /> <!-- adaptation coefficient for accel signal -->
    <!--<define name="FREQ" value="512"set fixed frequency, if not defined but INS/AHRS_PROPAGATE_FREQUENCY 
      is defined it is used, otherwise autofreq is used -->
  </section>
  
  <section name="AHRS" prefix="AHRS_">
    <define name="ALIGNER_SAMPLES_NB" value="1200" />  <!--When fidly plugging in a battery, aircraft kind of wobbly, now avoid messing up the aligner this way -->
    <define name="GRAVITY_HEURISTIC_FACTOR" value="60" />
    <define name="PROPAGATE_LOW_PASS_RATES" value="FALSE" />
    <define name="USE_GPS_HEADING" value="TRUE" /> <!-- True for Optitrack false for real magneto -->
    <!-- Local magnetic field -->
    <define name="H_X" value=" 0.51562740288882" />
    <define name="H_Y" value="-0.05707735220832" />
    <define name="H_Z" value=" 0.85490967783446" />
  </section>
  
  <section name="INS" prefix="INS_">
    <!-- Use GPS altitude measurments and set the R gain -->
    <define name="USE_GPS_ALT" value="1" />
    <define name="VFF_R_GPS" value="0.01" />
  </section>
  
  <section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">
    <define name="SP_MAX_PHI" value="45." unit="deg" />
    <define name="SP_MAX_THETA" value="45." unit="deg" />
    <define name="SP_MAX_R" value="300" unit="deg/s" />
    <define name="DEADBAND_A" value="0" />
    <define name="DEADBAND_E" value="0" />
    <define name="DEADBAND_R" value="50" />
  </section>
  
  <section name="RADIO_CONTROL_CC2500" prefix="CC2500_">
    <define name="RX_LED" value="LED_2" />
    <define name="BIND_BUTTON" value="BIND_BUTTON" />
    <define name="TELEMETRY_SENSORS" value="SENSOR_NONE" />
  </section>
  
  <section name="GPIO_EXT" prefix="GPIO_EXT_">
    <define name="PROVIDER1" value="GPIO_EXT_PCA95XX"/>
    <define name="BLOCKING1" value="TRUE"/>
    <define name="I2C_PERIPH1" value="&softi2c0"/>
    <define name="I2C_ADDRESS1" value="0x82"/>
  </section>
  
  <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
    <define name="REF_OMEGA_P" value="450" unit="deg/s" />
    <define name="REF_ZETA_P" value="0.9" />
    <define name="REF_MAX_P" value="600." unit="deg/s" />
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)" />

    <define name="REF_OMEGA_Q" value="450" unit="deg/s" />
    <define name="REF_ZETA_Q" value="0.9" />
    <define name="REF_MAX_Q" value="600." unit="deg/s" />
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)" />

    <define name="REF_OMEGA_R" value="450" unit="deg/s" />
    <define name="REF_ZETA_R" value="0.9" />
    <define name="REF_MAX_R" value="600." unit="deg/s" />
    <define name="REF_MAX_RDOT" value="RadOfDeg(1800.)" />
  </section>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <define name="PHI_PGAIN" value="45" />
    <define name="PHI_DGAIN" value="40" />
    <define name="PHI_IGAIN" value="5" />

    <define name="THETA_PGAIN" value="45" />
    <define name="THETA_DGAIN" value="40" />
    <define name="THETA_IGAIN" value="5" />

    <define name="PSI_PGAIN" value="520" />
    <define name="PSI_DGAIN" value="170" />
    <define name="PSI_IGAIN" value="3" />

    <define name="PHI_DDGAIN" value="0" />
    <define name="THETA_DDGAIN" value="0" />
    <define name="PSI_DDGAIN" value="0" />
  </section>
  
  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="MAX_BANK" value="20." unit="deg" />
    <define name="USE_SPEED_REF" value="TRUE" />
    <define name="PGAIN" value="650" />
    <define name="DGAIN" value="350" />
    <define name="AGAIN" value="70" />
    <define name="IGAIN" value="20" />
  </section>

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP" value="150" />
    <define name="HOVER_KD" value="80" />
    <define name="HOVER_KI" value="20" />
    <define name="NOMINAL_HOVER_THROTTLE" value="0.21" />
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE" />
  </section>

  <section name="NAVIGATION" prefix="NAV_">
    <define name="CLIMB_VSPEED" value="1.0" unit="m/s" />
    <define name="DESCEND_VSPEED" value="-0.7" unit="m/s" />
  </section>

  <section name="MISC">
    <define name="ARRIVED_AT_WAYPOINT" value="0.2" unit="m" />
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="FL, FR, BR, BL" type="string[]" />
    <define name="JSBSIM_MODEL" value="simple_quad" type="string" />
    <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string" />
  </section>
  
  <section name="AUTOPILOT">
    <define name="MODE_STARTUP" value="AP_MODE_ATTITUDE_DIRECT" />
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT" />
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_CLIMB" />
    <define name="MODE_AUTO2" value="AP_MODE_GUIDED" />
    <define name="USE_KILL_SWITCH_FOR_MOTOR_ARMING" value="TRUE" />
    <define name="NO_RC_THRUST_LIMIT" value="TRUE" />
  </section>

  <!-- If flying on a 2x 1S 300mAh 40/80C LiPo -->
  <section name="BAT">
    <define name="MAX_BAT_CAPACITY" value="300" unit="mAh" />
    <!-- tested at V 7.6 the avg -->  <!-- idle RPM then ?A half throttle ?A -->
    <define name="MILLIAMP_AT_IDLE_THROTTLE" value="10" unit="mA" />  <!-- TODO ??mA, with additional RC receiver and wifi and jevois cam ~??mA -->
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="240" unit="mA" /> <!-- TODO At 7.2 ?? A at 8.2v ??A rounded then to ?? to be at safe side -->
    <define name="CATASTROPHIC_BAT_LEVEL" value="6.0" unit="V" /> <!-- TODO: test when AP board switches off -->
    <define name="CRITIC_BAT_LEVEL" value="6.6" unit="V" />
    <define name="LOW_BAT_LEVEL" value="7.0" unit="V" />
    <define name="MAX_BAT_LEVEL" value="8.7" unit="V" />  <!-- 2s LiPo HV 2x4.35 = 8.7 -->
  </section>

  <section name="GCS">
    <define name="SPEECH_NAME" value="Trashcan" />
    <define name="AC_ICON" value="quadrotor_x" />
    <define name="ALT_SHIFT_PLUS_PLUS" value="2" /> <!-- 2m low diff for e.g. optitrack, use e.g 10m for outside -->
    <define name="ALT_SHIFT_PLUS" value="1" unit="m" />
    <define name="ALT_SHIFT_MINUS" value="-1" unit="m" />
  </section>

</airframe>
