Paparazzi files (proposed):
sw/airborne/peripherals/cc2500.c
sw/airborne/peripherals/cc2500.h
sw/airborne/peripherals/cc2500_regs.h
sw/airborne/subsystems/radio_control/frskyX.c
sw/airborne/subsystems/radio_control/frskyX.h
sw/airborne/subsystems/radio_control/frskyX_cc2500.c
sw/airborne/subsystems/radio_control/frskyX_cc2500.h


betaflight files:
DONE main/drivers/rx/rx_cc2500.h     --  Register defines, etc
DONE main/drivers/rx/rx_cc2500.c     --  Read, write, reset functions
DONE main/rx/cc2500_common.h         --  Init, Rssi, Tx enable/disable
DONE main/rx/cc2500_common.c         --  Init, Rssi, Tx enable/disable
main/rx/cc2500_frsky_common.h   --  FrSky init, receive, process
main/rx/cc2500_frsky_shared.h   --  FrSky enum and defines
main/rx/cc2500_frsky_shared.c   --  Init, tune, bind functions
main/rx/cc2500_frsky_x.h        --  FrSkyX init, handle, process
main/rx/cc2500_frsky_x.c        --  FrSkyX implementation
(main/pg/rx_spi_cc2500.c)         --  "Settings"


New proposal:
sw/airborne/peripherals/rx_cc2500.ch
sw/airborne/subsystems/radio_control/cc2500_xxxx.ch
sw/airborne/subsystems/radio_control/cc2500_compat.ch <-- Compatibility code
sw/airborne/subsystems/radio_control/cc2500_paparazzi.ch <-- Paparazzi-specific code
sw/airborne/subsystems/radio_control/cc2500_settings.ch  <-- Settings structs



https://github.com/betaflight/betaflight/blob/master/docs/boards/Board%20-%20CrazyBeeF4FRPro.md



Indirect calls for frsky_x:
(RX task)
rxUpdateCheck                       [Calls .rcFrameStatusFn (always). Handles signal timouts.]
--> rxRuntimeState.rcFrameStatusFn  [ptr]
--> rxSpiFrameStatus                [Calls protocolDataReceived (always), sets rxSpiNewPacketAvailable, returns status]
--> protocolDataReceived            [ptr]
--> frSkySpiDataReceived            [protocolState machine (binding). Calls handlePacket in non-binding states]
--> handlePacket                    [ptr]
--> frSkyXHandlePacket              [Very complex packet and telemetry handling]
--> buildTelemetryFrame             [// check syncronization at startup ok if not no sport telemetry]
--> appendSmartportData             [adds bytes to ringbuffer]

(fc/core.c:processRx)                   [also calls updateRssi]
(calculateRxChannelsAndUpdateFailsafe)  [If auxiliaryProcessingRequired calls .rcProcessFrame. Calls readRxChannelsApplyRanges based on timing.]
(readRxChannelsApplyRanges)             [Calls .rcReadRawFn per channel (always). Applies calibration. Sets rcRaw]
--> rxRuntimeState.rcReadRawFn          [ptr]
--> rxSpiReadRawRC                      [If rxSpiNewPacketAvailable <-- set by rxSpiFrameStatus or rxSpiProcessFrame]
--> protocolSetRcDataFromPayload        [ptr]
--> frSkySpiSetRcData                   [only calls setRcData]
--> setRcData                           [ptr]
--> frSkyXSetRcData                     [Copies from packet to rcData array]

(fc/core.c:processRx)
(calculateRxChannelsAndUpdateFailsafe)  [If auxiliaryProcessingRequired calls .rcProcessFrame. Calls readRxChannelsApplyRanges based on timing.]
--> rxRuntimeState.rcProcessFrameFn
--> rxSpiProcessFrame     [Calls protocolProcessFrame (always). Sets rxSpiNewPacketAvailable.]
--> protocolProcessFrame  [ptr]
--> frSkySpiProcessFrame  [Calls processFrame (always)]
--> processFrame          [ptr]
--> frSkyXProcessFrame    [Telemetry/smartport stuff]




Smartport notes:
processSmartPortTelemetry: <== TODO replace with own function rather than porting? Or add paparazzilink ID and keep frsky telemetry?
                           <== OR do both: keep FrSky telemetry as-is, separately call smartPortSendMessage for paparazzilink.
- Handles MSP (will do later)
- Calls smartPortSendPackage per message.
That's it.




frsky_x.c: telemetryWriteFrame, SendByte write to telemtryOutBuffer but do not actually send!

rxUpdateCheck
...
frSkyXHandlePacket (STATE_DATA) STATE_TELEMETRY? -> contains delay in event function!
==> buildTelemetryFrame   // check syncronization at startup ok if not no sport telemetry
==> appendSmartportData

IDEA: move receiver code to periodic function with correct frequency?




Trace telemetry from writeFifo:
(rcFrameStatusFn, see above)
...
--> frSkyXHandlePacket
--> cc2500WriteFifo       [Is actually reached already...]




Are all telemetry functions called?
cc2500_frsky_x.c:
  bool telemetryEnabled <= initSmartPortTelemetryExternal <= true or false TODO check
  calculateCrc <= buildTelemetryFrame, isValidPacket
  appendSmartPortData <= buildTelemetryFrame
  buildTelemetryFrame <= frSkyXHandlePacket
  frSkyXReadyToSend <= frSkyXProcessFrame
  frSkyXTelemetrySendByte <= frSkyXTelemetryWriteFrame
  frSkyXTelemetryWriteFrame <= frSkyXInit (arg to initSmartPortTelemetryExternal)
  isValidPacket <= frSkyXHandlePacket
  frSkyXHandlePacket <= frSkySpiInit (handlepacket = )
  frSkyXProcessFrame <= frSkySpiInit (processFrame = )
  frSkySpiXInit <= frSkySpiInit
cc2500_frsky_shared.c:
  handlePacket <= frSkySpiDataReceived
  frSkySpiDataReceived <= rxSpiSetProtocol (protocolDataReceived = )
  processFrame <= frSkySpiProcessFrame
  frSkySpiProcessFrame <= rxSpiSetProtocol (protocolProcessFrame = )
cc2500_rx_spi.c:
  rxSpiSetProtocol <= rxSpiInit
  protocolDataReceived <= rxSpiFrameStatus
  rxSpiFrameStatus <= rxSpiInit (rxRuntimeState->rcFrameStatusFn = )
  protocolProcessFrame <= rxSpiProcessFrame
  rxSpiProcessFrame <= rxSpiInit (rxRuntimeState->rcProcessFrameFn = )
cc2500_rx.c:
  rxInit <= radio_control_impl_init
  rxRuntimeState.rcFrameStatusFn <= radio_control_impl_event
  rxRuntimeState.rcProcessFrameFn <= radio_control_impl_event
cc2500_smartport.c:
  smartPortDataReceive <= frSkyXProcessFrame
  smartPortSendPackage <= processSmartPortTelemetry
  processSmartPortTelemetry <= frSkyXProcessFrame
  initSmartPortSensors <= initSmartPortTelemetryExternal
  initSmartPortTelemetryExternal <= frSkyXInit



handleSmartPortTelemetry is called by telemetry task in betaflight, but not in paparazzi!
Same for initSmartPortTelemetry
Maybe serial port needs to be initialized anyway, even though it is not used.
Check out  betaflight/src/main/telemetry/telemetry.c  which is not ported right now...

